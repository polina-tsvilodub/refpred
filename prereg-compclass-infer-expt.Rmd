# Comparison Class Inference Experiment Analysis

``` {r libraries}
library(tidyverse)
library(tidyboot)
library(brms)
library(lmerTest)
```

``` {r data}
# read data
d_infer <- read_csv('./data/results_30_prereg-cc-inf.csv')
                         
```

``` {r filter}
# exclude participants who report difficulties 
d_infer %>% select(submission_id, comments, problems) %>% distinct() %>% View()
d_infer <- subset(d_infer, !(submission_id %in% c(1438, 1515)))

# exclude data from non-native English speakers and those where the language information is missing
d_infer %>% distinct(languages)
d_infer_filt <- d_infer %>% 
  filter(grepl("en", languages, ignore.case = T)) %>%
  select(submission_id, trial_name, trial_number, target_size, item, botresponse, response,
         condition,  pic, pic_spec, ref_spec, attempts)

# participants who do not get the comparison class warmup right
d_infer_cc_warmup <- d_infer_filt %>% filter( trial_name == "comp_class_warmup") %>%
  group_by(submission_id) %>% count() %>% 
  filter( n > 4 )

# exclude participants who need more than 4 attempts per warmup
d_infer_warmup <- d_infer_filt %>% 
  filter( (trial_name == "warmup1") | (trial_name == "warmup2")) %>% 
  group_by(submission_id) %>%
  filter(attempts > 4)

d_infer_filt1 <- anti_join(d_infer_filt, d_infer_warmup, by = c("submission_id"))
d_infer_filt1 <- anti_join(d_infer_filt1, d_infer_cc_warmup, by = c("submission_id"))
```

``` {r categorization}
d_infer_main <- d_infer_filt1 %>% filter((trial_name == "custom_main_text1")| 
                                          (trial_name == "custom_main_text2")) %>%
  filter(submission_id != 1548) %>% filter(submission_id != 1549) %>%
  mutate(context = factor(pic_spec, levels = c(0, 1), 
                          labels = c("basic", 
                                     "subordinate")),
         NP = ifelse(ref_spec == 2, "one", 
                     ifelse(ref_spec == 1, "subordinate", "basic")),
         condition = ifelse(condition == 0, "prenominal", "predicative")) %>%
  select(submission_id, trial_number, context, item, response, condition,
        pic, target_size, NP)

# categorize responses
d_infer_main %>% distinct(response) %>% View()
# exclude invalid responses 
d_infer_valid <- d_infer_main %>% subset(., !(tolower(response) %in% c("that man is big", "that's small boy", "that is big one", "that's a small doberman",
                                                                      "that bird compare small", "that boy is small", "me is big", "but some one small", "that pug small",
                                                                      "you are small", "beauty for fish", "yes", "aim", "growth", "honest", "medicine", "heathy", "dogs name", "trees name",
                                                                      "big", "tall", "small", "cute", "good", "bushes",
                                                                      "why it in land", "what is this flower", "fish nose", "labrador")))
d_infer_main_responseCat <- d_infer_valid %>%
  rowwise() %>%
  mutate(  
    response_cat =
      ifelse( # do be extended dependent on responses provided
        tolower(response) %in% c("birds", "bird", "dogs", "fish", "flowers", "birds in the sky", "big dogs", "fower", "tress", "things", "objects", "dogs.", "dogd",
                                 "burds", "dogs that we see", "fish that we see", "birds that we see",
                                 "flower", "trees","tree", "animal", "the other birds", "the other dogs", "digs", "treees", "weeds", "small flowers", "fishs",
                                 "fishes", "dog", "large dogs", "giant trees", "breeds", "plant", "variety of dogs", "long trees"), "basic", "subordinate"),
    
    response_num = ifelse(response_cat == "basic", 1, 0),
    response_label = "basic"
  )

```

``` {r}
# explicit numeric coding to improve model convergence 
d_infer_main_responseCat <- d_infer_main_responseCat %>%
  mutate(syntax_contr = ifelse(condition == "predicative", 0.5, -0.5), # contrast coded
         NP_basic = ifelse(NP == "basic", 1, 0), # treatment coded
         NP_sub = ifelse(NP == "subordinate", 1, 0),
         context_sub = ifelse(context == "subordinate", 1, 0))
```

``` {r proportions plot}
# plot
bar.width = 0.8
d_infer_main_responseCat %>%  
  group_by( context, NP, condition) %>%
  tidyboot_mean(column = response_num) %>% ungroup() %>% 
  mutate(condition = factor(condition, levels = c("prenominal",  "predicative"), 
                            labels = c("Predicate",  "Subject"))) -> d_infer_main_responseCat.bs

d_infer_main_responseCat.bs %>%
  ggplot(aes(x=condition, y = mean, fill = NP, ymin = ci_lower, ymax = ci_upper)) +
  geom_col(position = position_dodge(bar.width), width = bar.width) +
  geom_linerange(position = position_dodge(bar.width)) + 
  xlab("Syntactic condition") +
  ylab("proportion of basic-level responses")+
  facet_grid(~context)  

```


``` {r lmer}
lm.infer.fit <- glmer(response_num ~ syntax_contr + NP_basic + NP_sub + context_sub  + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub +
                        context_sub:NP_basic + context_sub:NP_sub +
                        syntax_contr:context_sub +
                        syntax_contr:NP_basic:context_sub +
                        syntax_contr:NP_sub:context_sub +
                        (1 + syntax_contr + NP_basic + NP_sub + context_sub  + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub +
                        context_sub:NP_basic + context_sub:NP_sub +
                        syntax_contr:context_sub +
                        syntax_contr:NP_basic:context_sub +
                        syntax_contr:NP_sub:context_sub || submission_id) + 
                        (1 + syntax_contr + NP_basic + NP_sub + context_sub  + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub +
                        context_sub:NP_basic + context_sub:NP_sub +
                        syntax_contr:context_sub +
                        syntax_contr:NP_basic:context_sub +
                        syntax_contr:NP_sub:context_sub || item), 
                      data = d_infer_main_responseCat, 
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                  )
summary(lm.infer.fit) # full model with (deficient)
summary(lm.infer.fit2)
```

``` {r brm model}
# Bayesian full model
lm.b.infer.fit <- brm(response_num ~ syntax_contr + NP_basic + NP_sub + context_sub  + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub +
                        context_sub:NP_basic + context_sub:NP_sub +
                        syntax_contr:context_sub +
                        syntax_contr:NP_basic:context_sub +
                        syntax_contr:NP_sub:context_sub +
                        (1 + syntax_contr + NP_basic + NP_sub + context_sub  + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub +
                        context_sub:NP_basic + context_sub:NP_sub +
                        syntax_contr:context_sub +
                        syntax_contr:NP_basic:context_sub +
                        syntax_contr:NP_sub:context_sub || submission_id) + 
                        (1 + syntax_contr + NP_basic + NP_sub + context_sub  + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub +
                        context_sub:NP_basic + context_sub:NP_sub +
                        syntax_contr:context_sub +
                        syntax_contr:NP_basic:context_sub +
                        syntax_contr:NP_sub:context_sub || item), 
                      data = d_infer_main_responseCat, 
                      family = "bernoulli",
                      cores = 4)
summary(lm.b.infer.fit)
```


``` {r}
# secondary analysis
# subsetting the data by context condition
d_infer_contextBasic <- d_infer_main_responseCat %>% 
  filter(context == "basic")
d_infer_contextSub <- d_infer_main_responseCat %>%
  filter(context == "subordinate")

# lmer analysis 
lm.infer.context.basic <- glmer(response_num ~ syntax_contr + NP_basic + NP_sub  + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub +
                        (1 + syntax_contr + NP_basic + NP_sub + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub || submission_id) + 
                        (1 + syntax_contr + NP_basic + NP_sub + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub || item), 
                      data = d_infer_contextBasic, 
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )

lm.infer.context.sub <- glmer(response_num ~ syntax_contr + NP_basic + NP_sub + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub +
                        (1 + syntax_contr + NP_basic + NP_sub + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub || submission_id) + 
                        (1 + syntax_contr + NP_basic + NP_sub + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub || item), 
                        data = d_infer_contextSub,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
summary(lm.infer.context.basic)
summary(lm.infer.context.sub)

b.context.basic <- brm(response_num ~ syntax_contr + NP_basic + NP_sub  + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub +
                        (1 + syntax_contr + NP_basic + NP_sub + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub || submission_id) + 
                        (1 + syntax_contr + NP_basic + NP_sub + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub || item), 
                      data = d_infer_contextBasic, 
                      family = "bernoulli",
                      cores = 4)
b.context.sub <- brm(response_num ~ syntax_contr + NP_basic + NP_sub + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub +
                        (1 + syntax_contr + NP_basic + NP_sub + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub || submission_id) + 
                        (1 + syntax_contr + NP_basic + NP_sub + 
                        syntax_contr:NP_basic + syntax_contr:NP_sub || item), 
                        data = d_infer_contextSub,
                      family = "bernoulli",
                     cores = 4)
summary(b.context.basic)
summary(b.context.sub)
```

``` {r}
# subset by NP
d_infer_contextBasic_sub <- d_infer_contextBasic %>%
  filter(NP == "subordinate")
d_infer_contextBasic_basic <- d_infer_contextBasic %>%
  filter(NP = "basic")
d_infer_contextBasic_one <- d_infer_contextBasic %>% 
  filter(NP == "one")

lm.basic.sub <- glmer(response_num ~ syntax_contr +
                        (1 + syntax_contr | submission_id)+
                        (1 + syntax_contr | item),
                      data = d_infer_contextBasic_sub,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
lm.basic.basic <- glmer(response_num ~ syntax_contr +
                        (1 + syntax_contr | submission_id)+
                        (1 + syntax_contr | item),
                      data = d_infer_contextBasic_basic,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
lm.basic.one <- glmer(response_num ~ syntax_contr +
                        (1 + syntax_contr | submission_id)+
                        (1 + syntax_contr | item),
                      data = d_infer_contextBasic_one,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )

d_infer_contextSub_sub <- d_infer_contextSub %>%
  filter(NP == "subordinate")
d_infer_contextSub_basic <- d_infer_contextSub %>%
  filter(NP = "basic")
d_infer_contextSub_one <- d_infer_contextSub %>%
  filter(NP == "one")

lm.sub.sub <- glmer(response_num ~ syntax_contr +
                        (1 + syntax_contr | submission_id)+
                        (1 + syntax_contr | item),
                      data = d_infer_contextSub_sub,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
lm.sub.basic <- glmer(response_num ~ syntax_contr +
                        (1 + syntax_contr | submission_id)+
                        (1 + syntax_contr | item),
                      data = d_infer_contextSub_basic,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
lm.sub.one <- glmer(response_num ~ syntax_contr +
                        (1 + syntax_contr | submission_id)+
                        (1 + syntax_contr | item),
                      data = d_infer_contextSub_one,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
```

``` {r}
# secondary analysis without the NP 'one'
d_infer_subsetNP <- d_infer_main_responseCat %>%
  filter(NP != "one")
d_infer_subsetNP <- d_infer_subsetNP %>%
  mutate(NP_treatment = ifelse(NP == "subordinate", 1, 0))

lm.infer.subset <- glmer(response_num ~ syntax_contr + NP_treatment + context_sub  + 
                        syntax_contr:NP_treatment +
                        context_sub:NP_treatment 
                        syntax_contr:context_sub +
                        syntax_contr:NP_treatment:context_sub +
                        (1 + syntax_contr + NP_treatment + context_sub  + 
                        syntax_contr:NP_treatment +
                        context_sub:NP_treatment +
                        syntax_contr:context_sub +
                        syntax_contr:NP_treatment:context_sub | submission_id) + 
                        (1 + syntax_contr + NP_treatment + context_sub  + 
                        syntax_contr:NP_treatment +
                        context_sub:NP_treatment +
                        syntax_contr:context_sub +
                        syntax_contr:NP_treatment:context_sub  | item), 
                      data = d_infer_main_responseCat, 
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
# subset by context
d_subset_contextBasic <- d_infer_subsetNP %>%
  filter(context == "basic")
d_subset_contextSub <- d_infer_subsetNP %>%
  filter(context == "subordinate")
# similar subsets and analyses as above will be performed 
lm.subset.context.basic <- glmer(response_num ~ syntax_contr + NP_treatment  + 
                        syntax_contr:NP_treatment + 
                        (1 + syntax_contr + NP_treatment + 
                        syntax_contr:NP_treatment | submission_id) + 
                        (1 + syntax_contr + NP_treatment + 
                        syntax_contr:NP_treatment | item), 
                      data = d_subset_contextBasic, 
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
lm.subset.context.sub <- glmer(response_num ~ syntax_contr + NP_treatment  + 
                        syntax_contr:NP_treatment + 
                        (1 + syntax_contr + NP_treatment + 
                        syntax_contr:NP_treatment | submission_id) + 
                        (1 + syntax_contr + NP_treatment + 
                        syntax_contr:NP_treatment | item), 
                      data = d_subset_contextSub, 
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
d_subset_contextSub_sub <- d_subset_contextSub %>%
  filter(NP == "subordinate")
d_subset_contextSub_basic <- d_subset_contextSub %>%
  filter(NP = "basic")
d_subset_contextSub_one <- d_subset_contextSub %>%
  filter(NP == "one")

lm.subset.sub.sub <- glmer(response_num ~ syntax_contr +
                        (1 + syntax_contr | submission_id)+
                        (1 + syntax_contr | item),
                      data = d_subset_contextSub_sub,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
lm.subset.sub.basic <- glmer(response_num ~ syntax_contr +
                        (1 + syntax_contr | submission_id)+
                        (1 + syntax_contr | item),
                      data = d_subset_contextSub_basic,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
lm.subset.sub.one <- glmer(response_num ~ syntax_contr +
                        (1 + syntax_contr | submission_id)+
                        (1 + syntax_contr | item),
                      data = d_subset_contextSub_one,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )

d_subset_contextBasic_sub <- d_subset_contextBasic %>%
  filter(NP == "subordinate")
d_subset_contextBasic_basic <- d_subset_contextBasic %>%
  filter(NP = "basic")
d_subset_contextBasic_one <- d_subset_contextBasic %>%
  filter(NP == "one")

lm.subset.basic.sub <- glmer(response_num ~ syntax_contr +
                        (1 + syntax_contr | submission_id)+
                        (1 + syntax_contr | item),
                      data = d_subset_contextBasic_sub,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
lm.subset.basic.basic <- glmer(response_num ~ syntax_contr +
                        (1 + syntax_contr | submission_id)+
                        (1 + syntax_contr | item),
                      data = d_subset_contextBasic_basic,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
lm.subset.basic.one <- glmer(response_num ~ syntax_contr +
                        (1 + syntax_contr | submission_id)+
                        (1 + syntax_contr | item),
                      data = d_subset_contextBasic_one,
                      family = "binomial",
                      REML = F,
                      control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                      )
```